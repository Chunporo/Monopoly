var i=Object.defineProperty;var c=(n,e,t)=>e in n?i(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var r=(n,e,t)=>(c(n,typeof e!="symbol"?e+"":e,t),t);class u{constructor(e){r(this,"ws",null);r(this,"playerId","");r(this,"currentRoom",null);r(this,"serverUrl","");r(this,"connected",!1);r(this,"eventCallbacks",[]);r(this,"playerCallbacks",[]);r(this,"chatCallbacks",[]);r(this,"disconnectCallbacks",[]);r(this,"pendingRequests",new Map);this.serverUrl=e||{}.VITE_WS_SERVER_URL||"ws://localhost:3001"}async connect(){return new Promise((e,t)=>{this.ws=new WebSocket(this.serverUrl),this.ws.onopen=()=>{this.connected=!0,this.playerId=this.generatePlayerId(),e()},this.ws.onerror=s=>{t(new Error("WebSocket connection failed"))},this.ws.onclose=()=>{this.connected=!1,this.disconnectCallbacks.forEach(s=>s())},this.ws.onmessage=s=>{this.handleMessage(JSON.parse(s.data))}})}async disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}isConnected(){return this.connected}async createRoom(e,t,s){return this.sendRequest("createRoom",{hostName:e,hostIcon:t,maxPlayers:s})}async joinRoom(e,t,s){return this.sendRequest("joinRoom",{roomCode:e,playerName:t,playerIcon:s})}async leaveRoom(){return this.sendRequest("leaveRoom",{})}async setReady(e){return this.sendRequest("setReady",{ready:e})}async startGame(){return this.sendRequest("startGame",{})}async rollDice(){return this.sendRequest("rollDice",{})}async buyProperty(e){return this.sendRequest("buyProperty",{position:e})}async skipProperty(){return this.sendRequest("skipProperty",{})}async payRent(e,t){return this.sendRequest("payRent",{amount:e,toPlayerId:t})}async movePlayer(e){return this.sendRequest("movePlayer",{position:e})}async endTurn(){return this.sendRequest("endTurn",{})}async payJailFee(){return this.sendRequest("payJailFee",{})}async useGetOutCard(){return this.sendRequest("useGetOutCard",{})}async rollForJail(){return this.sendRequest("rollForJail",{})}async proposeTrade(e,t){return this.sendRequest("proposeTrade",{toPlayerId:e,offer:t})}async acceptTrade(e){return this.sendRequest("acceptTrade",{tradeId:e})}async rejectTrade(e){return this.sendRequest("rejectTrade",{tradeId:e})}async sendMessage(e){return this.sendRequest("sendMessage",{message:e})}onGameEvent(e){return this.eventCallbacks.push(e),()=>{this.eventCallbacks=this.eventCallbacks.filter(t=>t!==e)}}onPlayerUpdate(e){return this.playerCallbacks.push(e),()=>{this.playerCallbacks=this.playerCallbacks.filter(t=>t!==e)}}onChatMessage(e){return this.chatCallbacks.push(e),()=>{this.chatCallbacks=this.chatCallbacks.filter(t=>t!==e)}}onDisconnect(e){return this.disconnectCallbacks.push(e),()=>{this.disconnectCallbacks=this.disconnectCallbacks.filter(t=>t!==e)}}getCurrentRoom(){return this.currentRoom}getCurrentPlayer(){return this.currentRoom&&this.currentRoom.players.find(e=>e.id===this.playerId)||null}getPlayerId(){return this.playerId}sendRequest(e,t){return new Promise((s,o)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){o(new Error("Not connected"));return}const a=this.generateRequestId();this.pendingRequests.set(a,{resolve:s,reject:o}),this.ws.send(JSON.stringify({type:"request",requestId:a,action:e,playerId:this.playerId,data:t})),setTimeout(()=>{this.pendingRequests.has(a)&&(this.pendingRequests.delete(a),o(new Error("Request timeout")))},1e4)})}handleMessage(e){switch(e.type){case"response":const t=this.pendingRequests.get(e.requestId);t&&(this.pendingRequests.delete(e.requestId),e.error?t.reject(new Error(e.error)):t.resolve(e.data));break;case"roomUpdate":this.currentRoom=e.room,this.playerCallbacks.forEach(s=>s(e.room.players));break;case"gameEvent":this.eventCallbacks.forEach(s=>s(e.event));break;case"chatMessage":this.chatCallbacks.forEach(s=>s(e.message));break;case"error":console.error("Server error:",e.error);break}}generatePlayerId(){return"player_"+Math.random().toString(36).substr(2,9)+"_"+Date.now()}generateRequestId(){return"req_"+Math.random().toString(36).substr(2,9)}}export{u as WebSocketGameService};
